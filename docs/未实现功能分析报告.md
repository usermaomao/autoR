# autoR v2.0 未实现功能分析报告

**生成日期**: 2025-11-20
**项目版本**: v2.0 (开发中)
**分析范围**: PRD 文档 vs 实际代码实现

---

## 📊 执行摘要

**总体完成度**: 约 55%

- ✅ **核心复习流程**: 90% - SM-2 算法、队列生成、评分、撤销已完成
- ✅ **字典查询**: 85% - 四层降级、多音字推断已完成，缺 L1 IndexedDB
- ❌ **PWA 离线能力**: 0% - **完全未实现**
- ⚠️ **数据管理**: 40% - CRUD 完成，缺导入/导出/语义去重
- ❌ **备份容灾**: 0% - **完全未实现**
- ⚠️ **统计分析**: 70% - 基础统计完成，缺图表和预测
- ⚠️ **交互体验**: 60% - 键盘快捷键完成，缺 TTS、暗色模式、多题型

---

## 🎯 架构演进现状

### PRD 规划的架构升级

| 维度 | v1.0 | v2.0 目标 | 实际状态 |
|-----|------|----------|---------|
| 前端 | Django Templates + HTMX | Vue 3 + Vite | ✅ 已完成 |
| 后端 | Django Monolith | Django + DRF | ✅ 已完成 |
| 客户端 | 浏览器 | **PWA** | ❌ **未实现** |
| 离线能力 | 无 | **Workbox + IndexedDB** | ❌ **未实现** |

**关键发现**: 项目完成了前后端分离，但 **v2.0 的核心卖点（PWA 离线能力）完全缺失**。

---

## ✅ 已实现的核心功能

### 1. 认证系统
- [x] 用户注册（带速率限制 5/hour）
- [x] 用户登录（带速率限制 10/hour）
- [x] Session 认证
- [x] CSRF 保护
- [x] 用户信息获取 API

**代码位置**: `backend/cards/views.py:29-84`

---

### 2. 卡片 CRUD
- [x] 创建卡片（自动补全）
- [x] 读取卡片列表（支持筛选）
- [x] 更新卡片（后端 API 已有）
- [x] 删除卡片
- [x] 按 Deck/Type/State 筛选
- [x] 关键字搜索

**代码位置**:
- 后端: `backend/cards/views.py:103-182`
- 前端: `frontend/src/views/Cards.vue`

---

### 3. SM-2 算法（完整实现）
- [x] EF（易忘因子）计算
- [x] 间隔计算（1天 → 6天 → interval × EF）
- [x] 学习步骤（10分钟 → 1天）
- [x] 难项标记（lapses ≥ 3）
- [x] 队列生成（到期 > 难项 > 新卡）
- [x] 状态转换（new → learning → review）

**代码位置**: `backend/cards/services/sm2.py`

**算法验证**:
```python
# EF 公式正确性
def calculate_ef(current_ef: float, quality: int) -> float:
    new_ef = current_ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02))
    return max(1.3, new_ef)

# 间隔计算正确性
# quality < 3: 回到学习阶段（0 天）
# quality ≥ 3: 1天 → 6天 → interval × EF
```

---

### 4. 复习会话
- [x] 获取复习队列（优先级排序）
- [x] 提交评分（0=Again, 2=Hard, 4=Good, 5=Easy）
- [x] 撤销上一次复习
- [x] 键盘快捷键（1/2/3/4/空格/Z）
- [x] 实时统计（完成数、正确率、平均耗时）

**代码位置**:
- 后端: `backend/cards/views.py:198-277`
- 前端: `frontend/src/views/Review.vue`

---

### 5. 字典查询（四层降级策略）

#### 英语单词查询
- [x] **L2: ECDICT 本地库**（77万词条）
- [x] Django Cache 缓存（1天 TTL）
- [x] 提取 CEFR 等级、Collins 星级
- [ ] ❌ L1: IndexedDB 前端缓存
- [ ] ❌ L3: 在线 API（dictionaryapi.dev）

**代码位置**: `backend/cards/views.py:282-332`

#### 汉字查询
- [x] **L2: 本地 hanzi_local.db**
- [x] **L3: 百度汉语 API**
- [x] 自动保存百度结果到本地（hanzi_baidu 表）
- [x] Django Cache 缓存（1天 TTL）
- [ ] ❌ L1: IndexedDB 前端缓存

**代码位置**: `backend/cards/views.py:398-504`

---

### 6. 多音字语境推断
- [x] jieba 分词
- [x] pypinyin 读音推断
- [x] 置信度评分（0.9/0.6）
- [x] 候选读音列表

**代码位置**: `backend/cards/views.py:506-556`

**示例**:
```
输入: char="行", context="银行"
输出: pinyin="háng", confidence=0.9

输入: char="行", context="我行我素"
输出: pinyin="xíng", confidence=0.9
```

---

### 7. 统计功能
- [x] 今日待复习数量
- [x] 新卡片数量
- [x] 总卡片数
- [x] 连续打卡天数（Streak）
- [x] 今日完成数/正确率
- [ ] ❌ 未来 7/30 天任务预测曲线
- [ ] ❌ 记忆稳定度趋势图

**代码位置**: `backend/cards/views.py:142-182`

---

### 8. 批量操作
- [x] 批量删除（前端已实现）
- [ ] ❌ 批量标签添加/移除
- [ ] ❌ 批量移动到 Deck
- [ ] ❌ 批量重排程

**代码位置**: `frontend/src/views/Cards.vue:54-66`

---

## ❌ 未实现的关键功能

### 高优先级（核心 v2.0 特性）

#### 1. PWA 离线支持 ⚠️ **致命缺失**

**PRD 要求**:
- 可安装到主屏幕
- Service Worker 离线缓存
- IndexedDB 存储离线数据
- 网络恢复后自动同步
- Workbox 配置

**当前状态**:
```bash
❌ 无 public/manifest.json
❌ 无 public/service-worker.js
❌ 无 IndexedDB 代码
❌ 无 Workbox 配置
❌ Vite 未配置 PWA 插件
```

**影响**:
- 无法离线使用（v2.0 核心卖点）
- 无法安装到手机主屏幕
- 弱网络环境体验差
- 无法实现"碎片化复习（地铁/通勤场景）"

**预计工作量**: 2-3 周

---

#### 2. L1 缓存层（IndexedDB）⚠️ **高优先级**

**PRD 要求**:
- 浏览器端缓存已查询词条
- TTL 30 天
- P95 延迟 <100ms

**当前状态**:
```javascript
// frontend/src/ - 完全无 IndexedDB 代码
// 当前仅依赖后端 Django cache
```

**影响**:
- 无法达到 <100ms 瞬时响应目标
- 每次查询都需要网络请求
- 离线状态无法自动补全

**预计工作量**: 1 周

---

#### 3. 导入/导出功能 ⚠️ **高优先级**

**PRD 要求**:
- CSV/JSON 格式
- Anki 兼容（字段映射）
- 语义指纹冲突检测
- 导入 1000 行 ≤5s
- 跳过/覆盖/合并策略

**当前状态**:
```python
# backend/cards/views.py - 无导入导出 API
# backend/cards/serializers.py - 无批量序列化器
# frontend/src/views/Cards.vue - 无导入导出 UI
```

**影响**:
- 用户无法从 Anki 迁移数据
- 无法批量录入大量卡片
- 无法备份/恢复数据
- 跨设备迁移困难

**预计工作量**: 1-2 周

---

#### 4. 语义指纹去重 ⚠️ **高优先级**

**PRD 要求**:
- 对核心字段（释义、例句）生成哈希
- 检测实质性重复（非纯词形匹配）
- 准确率 ≥95%

**当前状态**:
```python
# 完全未实现
```

**影响**:
- 导入时无法智能去重
- 可能产生大量重复卡片
- 手动排查效率低

**预计工作量**: 3-5 天

---

#### 5. 自动备份到 S3 ⚠️ **高优先级**

**PRD 要求**:
- 每日凌晨 2:00 cron 任务
- SQLite `.backup` 命令（不锁表）
- 上传到 S3 兼容存储
- 保留 30 天，超期自动清理
- MD5 校验文件完整性

**当前状态**:
```bash
❌ 无 cron 配置
❌ 无 S3 集成代码（boto3/minio）
❌ 无备份脚本
❌ 无恢复脚本
```

**影响**:
- 数据丢失风险高
- 无容灾能力
- 无法满足"备份恢复可用率 100%"目标

**预计工作量**: 1 周

---

### 中优先级（体验优化）

#### 6. TTS 语音播放 ⚠️ **中优先级**

**PRD 要求**:
- 音频播放按钮
- 英语单词发音
- 可选 Azure TTS 高质量语音

**当前状态**:
```vue
<!-- frontend/src/components/FlashCard.vue -->
<!-- 无音频播放组件 -->
```

**影响**:
- 无法进行听力练习
- "听音写词"题型无法实现

**预计工作量**: 2-3 天

---

#### 7. 多题型支持 ⚠️ **中优先级**

**PRD 要求**:
- 闪卡（默认）✅
- 拼写输入 ❌
- 听音写词 ❌
- 看拼音选字 ❌
- 可配置题型比例

**当前状态**:
```vue
<!-- 仅实现基础闪卡翻转 -->
```

**影响**:
- 学习方式单一
- 无法强化拼写能力
- 无法进行主动回忆训练

**预计工作量**: 1-2 周

---

#### 8. 暗色模式 ⚠️ **中优先级**

**PRD 要求**:
- 移动优先
- 暗色主题切换
- 跟随系统设置

**当前状态**:
```css
/* Tailwind 已配置，但未使用 dark: 前缀 */
```

**影响**:
- 夜间使用刺眼
- 移动端体验不佳

**预计工作量**: 2-3 天

---

#### 9. 批量操作（高级）⚠️ **中优先级**

**PRD 要求**:
- 批量标签添加/移除
- 批量移动到 Deck
- 批量删除 ✅
- 批量重排程（重置学习进度）

**当前状态**:
```vue
<!-- 仅实现批量删除 -->
```

**影响**:
- 大量卡片管理效率低下
- 无法批量调整卡片分类

**预计工作量**: 3-5 天

---

#### 10. 卡片编辑功能 ⚠️ **中优先级**

**PRD 要求**:
- 编辑已有卡片的所有字段
- 重新触发自动补全

**当前状态**:
```bash
# 后端 API 支持 UPDATE（DRF ViewSet）
# 前端无编辑页面
```

**影响**:
- 无法修正录入错误
- 无法更新释义

**预计工作量**: 2-3 天

---

#### 11. 突击模式（Cram）⚠️ **中优先级**

**PRD 要求**:
- 快速复习模式
- 不影响排程数据
- 临时学习场景

**当前状态**:
```python
# 完全未实现
```

**影响**:
- 考前突击无法支持
- 灵活性不足

**预计工作量**: 3-5 天

---

### 低优先级（增值功能）

#### 12. 每日提醒

**PRD 要求**:
- PWA 推送通知（优先）
- 邮件（备选）
- 时间窗口配置（20:00-22:00）

**当前状态**: ❌ 未实现

**依赖**: PWA Service Worker

---

#### 13. 笔顺动画

**PRD 要求**:
- 汉字笔顺可视化演示
- 标记为可选功能

**当前状态**: ❌ 未实现

---

#### 14. 手写识别

**PRD 要求**:
- 临摹练习
- 标记为可选功能

**当前状态**: ❌ 未实现

---

#### 15. FSRS 算法

**PRD 要求**:
- ML 算法替代 SM-2
- M4 可选功能

**当前状态**: ❌ 未实现

**备注**: SM-2 已足够，低优先级

---

#### 16. 统计图表

**PRD 要求**:
- 未来 7/30 天任务预测曲线
- 记忆稳定度趋势图
- Chart.js 可视化

**当前状态**:
```javascript
// 依赖已安装（chart.js）
// 但 Stats.vue 未使用
```

---

## 🔍 技术债务清单

### 1. 前端架构
- [ ] Pinia stores 不完整（仅有 user/review，缺 cards/decks）
- [ ] 无全局错误处理机制（仅用 alert）
- [ ] 无 Toast 通知组件
- [ ] 无 Loading 状态统一管理

---

### 2. 测试覆盖
- [ ] 前端完全无测试（0%）
- [ ] 后端仅有 SM-2 算法测试
- [ ] 无 API 集成测试
- [ ] 无 E2E 测试

---

### 3. 性能监控
- [ ] 无 P95 延迟监控
- [ ] 无性能指标收集
- [ ] 无错误追踪（Sentry 等）

---

### 4. 部署配置
- [ ] 无 Dockerfile
- [ ] 无 docker-compose.yml
- [ ] 无生产环境配置（gunicorn/nginx）
- [ ] 无 CI/CD 配置

---

### 5. 代码质量
- [ ] 无 ESLint/Prettier 配置
- [ ] 无 pre-commit hooks
- [ ] 无代码覆盖率报告

---

## 📈 建议的实现优先级

### Phase 1: 数据管理补齐（1-2 周）
**目标**: 完善基础 CRUD 功能，支持数据迁移

1. **导入/导出 API** ⚠️ 高优先级
   - 后端: CSV/JSON 序列化
   - 前端: 文件上传/下载 UI
   - Anki 字段映射

2. **语义指纹去重** ⚠️ 高优先级
   - 哈希算法实现
   - 冲突检测逻辑
   - 用户选择策略（跳过/覆盖/合并）

3. **卡片编辑功能** ⚠️ 中优先级
   - 前端编辑页面
   - 表单验证

4. **批量操作增强** ⚠️ 中优先级
   - 批量标签管理
   - 批量移动卡组

---

### Phase 2: PWA 基础设施（2-3 周）
**目标**: 实现离线能力，达到 v2.0 核心目标

1. **Service Worker + Manifest** ⚠️ 致命优先级
   - vite-plugin-pwa 配置
   - manifest.json 生成
   - 离线缓存静态资源

2. **IndexedDB 缓存层（L1）** ⚠️ 高优先级
   - 词条缓存（TTL 30天）
   - 卡片离线存储
   - 复习记录队列

3. **离线同步队列** ⚠️ 高优先级
   - Workbox Background Sync
   - 冲突解决策略

4. **安装提示** ⚠️ 中优先级
   - PWA 安装引导
   - "添加到主屏幕"提示

---

### Phase 3: 备份容灾（1 周）
**目标**: 保障数据安全

1. **S3 自动备份** ⚠️ 高优先级
   - cron 任务配置
   - boto3/minio SDK 集成
   - 备份脚本编写

2. **备份恢复** ⚠️ 高优先级
   - Django 管理命令
   - 恢复流程测试

3. **MD5 校验** ⚠️ 中优先级
   - 文件完整性验证

---

### Phase 4: 体验优化（2 周）
**目标**: 提升用户体验

1. **TTS 语音播放** ⚠️ 中优先级
   - Web Speech API
   - 或 Azure TTS 集成

2. **暗色模式** ⚠️ 中优先级
   - Tailwind dark: 前缀
   - 主题切换组件

3. **多题型支持** ⚠️ 中优先级
   - 拼写输入组件
   - 听音写词组件
   - 看拼音选字组件

4. **统计图表** ⚠️ 低优先级
   - Chart.js 集成
   - 预测曲线

---

### Phase 5: 部署上线（1 周）
**目标**: 生产环境部署

1. **Docker 化**
   - Dockerfile 编写
   - docker-compose.yml 配置

2. **生产配置**
   - gunicorn + nginx
   - 静态文件 CDN

3. **监控告警**
   - 性能监控
   - 错误追踪

---

## 🎯 验收标准对照

| PRD 指标 | 目标 | 当前状态 |
|---------|------|---------|
| **自动补全可用性** | ≥99% | ~85%（缺 L1 缓存） |
| **缓存命中延迟** | <100ms | ❌ 无前端缓存 |
| **本地库查询** | <300ms | ✅ 达标 |
| **在线查询** | <1200ms | ✅ 达标 |
| **队列生成** | ≤300ms | ✅ 达标 |
| **导入 1000 行** | ≤5s | ❌ 未实现 |
| **语义指纹准确率** | ≥95% | ❌ 未实现 |
| **备份恢复** | 15分钟 | ❌ 未实现 |
| **备份成功率** | 100% | ❌ 未实现 |
| **首屏加载 P95** | <900ms | ⚠️ 未测量 |
| **API 响应 P99** | <500ms | ⚠️ 未测量 |

---

## 📝 结论

### 核心优势
1. ✅ **SM-2 算法实现完善** - 复习效果有保障
2. ✅ **四层降级字典策略** - 数据获取稳定性高
3. ✅ **前后端分离架构** - 代码结构清晰

### 最大风险
1. ❌ **PWA 离线能力完全缺失** - v2.0 核心卖点未实现
2. ❌ **无数据备份机制** - 数据安全无保障
3. ❌ **无导入导出功能** - 用户迁移困难

### 建议
1. **优先实现 Phase 1 + Phase 3**（数据管理 + 备份）- 保障基本可用性
2. **其次实现 Phase 2**（PWA）- 实现 v2.0 核心价值
3. **最后实现 Phase 4**（体验优化）- 锦上添花

---

**报告生成工具**: Claude Code
**代码分析范围**: 前端 12 个文件 + 后端 Python 模块
**PRD 版本**: v2.0 (2025-11-20)
