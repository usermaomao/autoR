# autoR Phase 1: 数据管理补齐 - 详细计划

**开始日期**: 2025-11-20
**预计工期**: 1-2 周
**开发模式**: 交互式开发
**目标版本**: v2.1-alpha

---

## 📋 Phase 1 目标

完善基础数据管理功能，支持用户数据导入导出和批量操作。

### 核心价值
1. **用户可以从 Anki 迁移数据** - 降低切换成本
2. **数据可备份和恢复** - 提升数据安全感
3. **高效的批量管理** - 提升使用效率

### 验收标准
- [ ] 用户可以导入 CSV/JSON 格式的卡片（Anki 兼容）
- [ ] 用户可以导出所有卡片到 CSV/JSON
- [ ] 导入时自动检测重复并提供处理选项
- [ ] 用户可以编辑已有卡片的所有字段
- [ ] 用户可以批量添加标签、移动卡组、重置进度

---

## 🎯 功能清单

### 1. 导入/导出功能 ⚠️ 高优先级

#### 1.1 后端开发 (2-3天)

**任务**:
- [ ] 1.1.1 设计导入/导出 API 接口
- [ ] 1.1.2 实现 `CardImportSerializer` (支持 CSV/JSON)
- [ ] 1.1.3 实现 `CardExportSerializer` (支持 CSV/JSON)
- [ ] 1.1.4 实现 Anki 字段映射逻辑
- [ ] 1.1.5 创建导入视图 (`POST /api/cards/import/`)
- [ ] 1.1.6 创建导出视图 (`GET /api/cards/export/`)
- [ ] 1.1.7 添加错误处理和验证
- [ ] 1.1.8 编写单元测试

**技术决策点** (需确认):
- **决策 1**: CSV 解析库
  - 选项 A: Python 内置 `csv` 模块 (轻量级)
  - 选项 B: `pandas` (功能强大但增加依赖)
  - **推荐**: 选项 A (满足需求且无额外依赖)

- **决策 2**: Anki 字段映射
  - 选项 A: 固定映射 (Front→front, Back→back)
  - 选项 B: 用户自定义映射 (提供 UI 选择)
  - **推荐**: 选项 A 先实现，后续扩展

**API 设计草案**:
```python
# 导入 API
POST /api/cards/import/
Content-Type: multipart/form-data
{
  "file": <file>,
  "format": "csv" | "json",
  "deck_id": 1,
  "conflict_strategy": "skip" | "overwrite" | "merge"
}

Response:
{
  "total": 1000,
  "imported": 850,
  "skipped": 100,
  "failed": 50,
  "errors": [{"line": 10, "message": "Invalid format"}]
}

# 导出 API
GET /api/cards/export/?format=csv&deck_id=1
Response: CSV/JSON file download
```

#### 1.2 前端开发 (2-3天)

**任务**:
- [ ] 1.2.1 创建 `ImportDialog.vue` 组件
- [ ] 1.2.2 创建 `ExportDialog.vue` 组件
- [ ] 1.2.3 实现文件上传功能
- [ ] 1.2.4 实现格式选择 (CSV/JSON)
- [ ] 1.2.5 实现冲突策略选择 UI
- [ ] 1.2.6 显示导入进度（大文件支持）
- [ ] 1.2.7 显示导入结果统计
- [ ] 1.2.8 集成到 Cards 页面

**技术决策点** (需确认):
- **决策 3**: 前端文件解析
  - 选项 A: 原生 `FileReader` API
  - 选项 B: `papaparse` 库 (专业CSV解析)
  - **推荐**: 选项 B (错误处理更好，支持大文件)

**UI 草图**:
```
[Cards 页面]
  [导入] [导出] 按钮

[导入对话框]
  1. 选择文件 (拖拽或点击)
  2. 选择格式: ○ CSV ○ JSON
  3. 选择目标卡组: [下拉选择]
  4. 冲突处理: ○ 跳过 ○ 覆盖 ○ 合并
  5. [开始导入] 按钮

  进度条: ████████░░ 80% (800/1000)

  结果:
  ✓ 成功导入: 850
  ⚠ 跳过(重复): 100
  ✗ 失败: 50
```

**性能指标**:
- [ ] 导入 1000 行 ≤ 5 秒
- [ ] 支持 UTF-8 编码
- [ ] 大文件分块上传（>10MB）

---

### 2. 语义指纹去重 ⚠️ 高优先级

#### 2.1 后端开发 (1-2天)

**任务**:
- [ ] 2.1.1 设计语义指纹算法
- [ ] 2.1.2 添加 `semantic_hash` 字段到 Card 模型
- [ ] 2.1.3 创建数据库迁移（添加索引）
- [ ] 2.1.4 实现 `generate_semantic_hash()` 函数
- [ ] 2.1.5 在卡片创建/更新时自动生成哈希
- [ ] 2.1.6 实现去重检测逻辑
- [ ] 2.1.7 实现冲突解决策略
- [ ] 2.1.8 编写测试（准确率 ≥95%）

**技术决策点** (需确认):
- **决策 4**: 哈希算法选择
  - 选项 A: MD5 (fast + front + back)
  - 选项 B: SHA256 (更安全，略慢)
  - 选项 C: MD5 + Levenshtein 距离 (模糊匹配)
  - **推荐**: 选项 A (满足性能要求，足够准确)

**算法设计草案**:
```python
def generate_semantic_hash(card):
    """
    生成卡片语义指纹
    基于核心字段: front + back (忽略空格、大小写)
    """
    import hashlib

    # 规范化文本
    front = card.front.strip().lower()
    back = card.back.strip().lower()

    # 生成哈希
    content = f"{front}|{back}"
    return hashlib.md5(content.encode('utf-8')).hexdigest()

# 使用示例
card1 = Card(front="apple", back="苹果")
card2 = Card(front="Apple ", back=" 苹果")
# card1.semantic_hash == card2.semantic_hash  # True (重复)
```

**数据模型修改**:
```python
class Card(models.Model):
    # ... 现有字段 ...
    semantic_hash = models.CharField(
        max_length=32,
        db_index=True,  # 加速查询
        editable=False
    )

    def save(self, *args, **kwargs):
        # 自动生成哈希
        if not self.semantic_hash:
            self.semantic_hash = generate_semantic_hash(self)
        super().save(*args, **kwargs)
```

#### 2.2 前端集成 (1天)

**任务**:
- [ ] 2.2.1 导入时显示重复卡片列表
- [ ] 2.2.2 提供去重策略选择界面
- [ ] 2.2.3 显示相似度对比（并排显示）

**UI 草图**:
```
[导入 - 检测到重复]

  发现 100 张重复卡片:

  #1
  ┌─ 导入文件 ─────────┬─ 已有卡片 ─────────┐
  │ Front: Apple       │ Front: apple       │
  │ Back: 苹果         │ Back: 苹果         │
  │ Created: -         │ Created: 2025-01-01│
  └────────────────────┴────────────────────┘
  处理: ○ 跳过 ○ 覆盖 ● 保留两者

  [应用到全部] [逐个确认]
```

**性能指标**:
- [ ] 检测准确率 ≥ 95%
- [ ] 检测 1000 条记录 ≤ 2 秒

---

### 3. 卡片编辑功能 ⚠️ 中优先级

#### 3.1 后端验证 (0.5天)

**任务**:
- [ ] 3.1.1 验证 DRF ViewSet UPDATE 方法
- [ ] 3.1.2 添加编辑权限检查
- [ ] 3.1.3 支持重新触发自动补全
- [ ] 3.1.4 添加编辑历史记录（可选）

**API 验证**:
```python
# 现有 API (需验证是否完整)
PATCH /api/cards/{id}/
{
  "front": "new front",
  "back": "new back",
  "trigger_autocomplete": true  # 新增参数
}
```

#### 3.2 前端开发 (1.5天)

**任务**:
- [ ] 3.2.1 创建 `EditCardDialog.vue` 组件
- [ ] 3.2.2 复用 CardForm 表单组件
- [ ] 3.2.3 实现实时预览
- [ ] 3.2.4 添加"重新自动补全"选项
- [ ] 3.2.5 集成到 Cards 页面（右键菜单或详情按钮）
- [ ] 3.2.6 添加表单验证

**UI 草图**:
```
[编辑卡片]

  Front: [__________________]
  Back:  [__________________]
  Hint:  [__________________]
  Tags:  [tag1] [tag2] [x]
  Deck:  [下拉选择]

  ☑ 保存后重新自动补全

  [取消] [保存]
```

---

### 4. 批量操作增强 ⚠️ 中优先级

#### 4.1 后端开发 (1.5天)

**任务**:
- [ ] 4.1.1 实现批量标签 API (`POST /api/cards/bulk/tags/`)
- [ ] 4.1.2 实现批量移动 API (`POST /api/cards/bulk/move/`)
- [ ] 4.1.3 实现批量重排程 API (`POST /api/cards/bulk/reschedule/`)
- [ ] 4.1.4 实现批量删除（已有，验证即可）
- [ ] 4.1.5 添加批量操作日志
- [ ] 4.1.6 编写测试

**API 设计草案**:
```python
# 批量添加标签
POST /api/cards/bulk/tags/
{
  "card_ids": [1, 2, 3],
  "action": "add" | "remove",
  "tags": ["tag1", "tag2"]
}

# 批量移动卡组
POST /api/cards/bulk/move/
{
  "card_ids": [1, 2, 3],
  "deck_id": 5
}

# 批量重排程
POST /api/cards/bulk/reschedule/
{
  "card_ids": [1, 2, 3],
  "reset_learning": true
}
```

#### 4.2 前端开发 (1.5天)

**任务**:
- [ ] 4.2.1 添加批量选择 UI（复选框）
- [ ] 4.2.2 创建批量操作工具栏
- [ ] 4.2.3 创建批量操作对话框
- [ ] 4.2.4 显示操作进度（大批量时）
- [ ] 4.2.5 显示操作结果

**UI 草图**:
```
[Cards 页面 - 批量模式]

  [退出批量] 已选择 10 张卡片
  [添加标签] [移动到...] [重置进度] [删除]

  ┌──┬─────────┬─────────┬────────┐
  │☑│ Front   │ Back    │ State  │
  ├──┼─────────┼─────────┼────────┤
  │☑│ apple   │ 苹果    │ review │
  │☑│ banana  │ 香蕉    │ new    │
  └──┴─────────┴─────────┴────────┘

[批量添加标签对话框]
  选择标签: [tag1] [tag2] [tag3]
  或创建新标签: [_____________]
  [取消] [应用到 10 张卡片]
```

**性能指标**:
- [ ] 批量操作 1000 条记录 ≤ 3 秒
- [ ] 显示操作进度（每 100 条更新一次）

---

## 📅 开发时间表

### 第 1 周

| 天数 | 任务 | 预计工时 | 负责人 |
|-----|------|---------|--------|
| Day 1-2 | 导入功能后端开发 | 16h | Claude |
| Day 3 | 语义去重后端开发 | 8h | Claude |
| Day 4-5 | 导入功能前端开发 | 16h | Claude |

**第 1 周目标**: 完成导入功能和语义去重

---

### 第 2 周

| 天数 | 任务 | 预计工时 | 负责人 |
|-----|------|---------|--------|
| Day 6-7 | 导出功能开发 | 12h | Claude |
| Day 8 | 卡片编辑功能 | 8h | Claude |
| Day 9-10 | 批量操作开发 | 12h | Claude |
| Day 11-12 | 集成测试和修复 | 12h | Claude |

**第 2 周目标**: 完成导出、编辑、批量操作，通过集成测试

---

## 🧪 测试计划

### 单元测试 (覆盖率目标: 85%)

**后端测试**:
- [ ] 导入解析器测试（CSV/JSON 格式）
- [ ] 语义哈希算法测试
- [ ] 去重逻辑测试（准确率验证）
- [ ] 批量操作测试
- [ ] 边界条件测试（空文件、大文件、特殊字符）

**前端测试**:
- [ ] 文件上传组件测试
- [ ] 表单验证测试
- [ ] 批量选择逻辑测试

### 集成测试

- [ ] 完整导入流程测试
  - 上传 CSV → 解析 → 去重 → 确认 → 导入成功
- [ ] 冲突处理流程测试
  - 检测重复 → 用户选择策略 → 正确处理
- [ ] 批量操作端到端测试
  - 选择卡片 → 批量操作 → 验证结果

### 性能测试

- [ ] 导入 1000 行性能测试（目标 ≤ 5秒）
- [ ] 导出 10000 行性能测试（目标 ≤ 10秒）
- [ ] 批量操作 1000 条性能测试（目标 ≤ 3秒）
- [ ] 语义去重性能测试（1000 条 ≤ 2秒）

---

## 📊 进度追踪

### 完成标准
- [ ] 所有任务复选框勾选完成
- [ ] 单元测试覆盖率 ≥ 85%
- [ ] 集成测试全部通过
- [ ] 性能指标达标
- [ ] 代码审查通过（使用 codex-code-reviewer）
- [ ] 用户手册更新
- [ ] API 文档更新

### 里程碑

- [ ] **M1.1**: 导入功能后端完成 (Day 2)
- [ ] **M1.2**: 语义去重完成 (Day 3)
- [ ] **M1.3**: 导入功能前端完成 (Day 5)
- [ ] **M1.4**: 导出功能完成 (Day 7)
- [ ] **M1.5**: 编辑功能完成 (Day 8)
- [ ] **M1.6**: 批量操作完成 (Day 10)
- [ ] **M1.7**: Phase 1 验收通过 (Day 12)

---

## 🚦 风险和依赖

### 风险识别

1. **CSV 格式兼容性** (中等风险)
   - Anki 导出格式可能有多种变体
   - **缓解**: 支持常见格式，提供错误提示

2. **大文件导入性能** (中等风险)
   - 10000+ 行可能超时
   - **缓解**: 分块处理，显示进度

3. **字符编码问题** (低风险)
   - CSV 可能包含特殊字符
   - **缓解**: 强制 UTF-8，提供编码选择

### 技术依赖

- **后端**: 无新增依赖（使用内置 csv 模块）
- **前端**: 可能新增 papaparse 库（待确认）

---

## 📝 文档更新

### 需要更新的文档

- [ ] `CLAUDE.md` - 添加导入/导出/批量操作说明
- [ ] `docs/API.md` - 新增 API 文档
- [ ] `docs/用户手册.md` - 添加功能使用指南
- [ ] `README.md` - 更新功能列表

---

## ✅ 下一步行动

### 立即需要确认（等待用户反馈）

请您确认以下 4 个技术决策：

1. **CSV 解析库**:
   - ○ A) Python 内置 `csv` 模块（推荐）
   - ○ B) `pandas` 库

2. **前端文件解析**:
   - ○ A) 原生 `FileReader` API
   - ○ B) `papaparse` 库（推荐）

3. **语义哈希算法**:
   - ○ A) MD5（推荐）
   - ○ B) SHA256
   - ○ C) MD5 + Levenshtein 距离

4. **Anki 字段映射**:
   - ○ A) 固定映射（推荐，先实现）
   - ○ B) 用户自定义映射（后续扩展）

### 确认后的行动

1. 更新 plan.md 记录决策
2. 开始 Day 1-2: 导入功能后端开发
3. 每个里程碑完成后更新进度

---

**计划制定**: Claude Code
**最后更新**: 2025-11-20
**状态**: ⏳ 等待用户确认技术决策
