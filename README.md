# RPD/PRD — 基于艾宾浩斯记忆曲线的词汇/生字学习网站 v2.0

## 文档信息

- **名称**: RPD/PRD — 基于艾宾浩斯记忆曲线的词汇/生字学习网站
- **目标用户**: ≤10 人自用、小团队
- **版本**: v2.0 (PWA 架构升级版)
- **基线**: 移动端优先、支持离线、高可用、可扩展
- **背景与目标**: v1.0 验证了核心复习流程的有效性。v2.0 旨在通过架构升级和算法增强，提供媲美原生应用的体验，并确保数据获取的稳定性和备份的可靠性。

---

## 1. 背景与目标

- **问题**: v1.0 存在单点故障风险（API 依赖）、弱网络/离线场景体验不佳、复习算法较为初级等问题。
- **目标**: 解决上述问题，实现移动端友好、支持离线使用的 PWA 应用，通过多层数据源策略将可用性提升至 99%，并引入更科学的复习算法。
- **成功标准**: 录入-复习闭环无缝衔接，PWA 离线功能稳定，数据同步可靠，用户记忆效率（长期留存率）有明确提升。

## 2. 用户与场景

- **角色**: 学习者（主要）、管理员（同人或 1 人管理）
- **场景**:
  - 批量录入并自动补全（支持离线操作）
  - 碎片化复习（地铁/通勤场景，PWA 离线支持）
  - 难项强化（Leech 标记与专项训练）
  - 跨设备迁移（导出/导入 + PWA 同步）

## 3. 范围与非目标

- **范围**:
  - **核心功能**: 保持 v1.0 的条目管理、复习会话、统计、导入导出等功能。
  - **架构升级**: 全面转向 PWA 架构，支持离线使用和后台同步。
  - **算法增强**: 引入完整的 SM-2 算法，并为 FSRS 算法预留接口。
  - **数据源优化**: 建立四层降级数据获取策略。
  - **新增模块**: 多音字语境推断、数据导入冲突优化。
- **非目标**: 公共词库分享社区、复杂社交功能、海量并发（均可后续扩展）。

## 4. 架构演进

v2.0 的核心是架构的现代化演进，旨在提升用户体验、可靠性和未来的可扩展性。

| 维度 | v1.0 架构 (SSR) | v2.0 架构 (SPA + API) | 演进理由 |
| :--- | :--- | :--- | :--- |
| **前端** | Django Templates + HTMX | Vue 3 + Vite | 提供更丰富的交互和流畅的单页应用体验，组件化开发效率更高。 |
| **后端** | Django (Monolith) | Django + DRF (Django REST framework) | 前后端分离，API 接口更清晰，便于未来接入不同客户端（如原生 App）。 |
| **客户端** | 浏览器 | PWA (Progressive Web App) | **移动端友好**，可“安装”到主屏幕，提供**离线访问**和后台同步能力。 |
| **构建** | 无 | Vite | 极速的开发服务器和优化的生产构建，支持现代 JavaScript 特性。 |
| **离线能力**| 无（或需手动实现） | Workbox | 标准化的 PWA 解决方案，简化了缓存管理和离线队列。 |

**结论**: 新架构能更好地满足移动优先和高可用性的目标，是实现离线学习和卓越用户体验的必要基础。

---

## 5. 核心功能清单

### 5.1 条目管理
- **新增/编辑/删除**: 支持离线操作，网络恢复后同步
- **Deck/Tag**: 多维度分类管理
- **搜索去重**: 实时搜索 + 语义指纹去重
- **批量操作**: 批量导入/导出（CSV/JSON）

### 5.2 自动补全（v2.0 核心优化）

#### 英语字段
- **必填**: `word`（词条）
- **自动补全**:
  - `ipa`（国际音标）
  - `pos`（词性: noun/verb/adj 等）
  - `meaning_en`（英文释义）
  - `examples[]`（例句数组）
  - `audio_url`（发音音频链接）
- **可选**:
  - `meaning_zh`（中文释义）
  - `synonyms`（同义词）
  - `frequency`（词频）
  - `CEFR`（欧洲语言标准等级: A1-C2）

#### 汉字字段
- **必填**: `hanzi`（汉字/词语）
- **自动补全**:
  - `pinyin`（拼音，含声调）
  - `variants`（多音字候选数组）
  - `meaning_zh`（基础释义）
  - `examples`（例句/组词）
  - `radical`（部首）
  - `strokes`（笔画数）
  - `simplified`/`traditional`（简繁体对照）

#### 数据源 (四层降级策略)
- **L1: 本地缓存 (IndexedDB)**: 浏览器端缓存查过的词条，TTL 30 天，实现瞬时响应。
- **L2: 本地字典库**: 内置 `ECDICT` (77万词条) 和 `UniHan Database`，在无网络或 L1 未命中时提供基础释义。
- **L3: 在线 API**: 作为补充，调用 `dictionaryapi.dev` 获取更丰富的例句、音频等信息。
- **L4: 手动填写**: 所有自动渠道失败后，UI 保持可用，允许用户手动完成录入。

#### 交互流程
- **失焦自动补全**: 输入框失去焦点后自动触发查询
- **操作选项**: 补全/覆盖/合并/跳过
- **多候选处理**: 弹窗显示多音字/多义词候选
- **性能目标**: ≤1 秒返回缓存命中

#### 验收标准
- 自动补全可用性 ≥ 99%（L1-L4 综合）
- P95 延迟: 缓存命中 <100ms，本地库查询 <300ms，在线查询 <1200ms
- 失败降级不阻塞保存

### 5.3 复习会话与排程

#### 会话体验
- **闪卡模式**: 正反面可自定义字段显示，逐步揭示
- **评分四档**: Again / Hard / Good / Easy
- **交互支持**:
  - 键盘快捷键（1/2/3/4 或空格）
  - 撤销上一步（Undo）
  - TTS 播放按钮
  - 响应时长记录

#### 题型（可配置比例）
- **闪卡**（默认主要模式）
- **拼写输入**（大小写/近似容错）
- **听音写词**（英语）
- **看拼音选字**（汉语）

#### 排程算法 (完整 SM-2)
- **引入参数**:
  - `EF`（易忘因子, Easy Factor）: 初始 2.5，范围 [1.3, 2.5]
  - `D`（难度, Difficulty）: 根据平均评分动态调整
  - `S`（稳定度, Stability）: 继承 v1.0

- **核心公式**:
  ```
  EF' = EF + (0.1 - (5-q)*(0.08+(5-q)*0.02))  // q 为评分映射 0-5
  interval_new = interval_old * EF'
  ```

- **学习小步**:
  - 新学: 10 分钟 → 1 天
  - Again: 回退到学习队列
  - Good/Easy: 可直接进入复习

- **队列策略**:
  - 先到期卡片、后新卡
  - `daily_new_limit` 与 `daily_review_limit` 控制每日负荷
  - 难项优先（lapses ≥ 3）

- **难项标记 (Leech)**:
  - 触发条件: `lapses ≥ 3`
  - 动作: 加入"强化"清单，可暂缓或专项训练

- **可选模式**:
  - 突击模式（Cram，不影响排程）
  - 同源卡埋葬（Bury siblings）

- **M4 可选**: FSRS (Free Spaced Repetition Scheduler) 机器学习算法

#### 验收标准
- 队列生成 ≤300ms
- 评分后即时更新 `due_at`、`EF`、`interval`
- 一日复习误差不超过 1 项
- 算法参数可后台调整

### 5.4 汉字专属功能

- **多音字语境推断**: 结合 `jieba` 分词和词性标注，在组词语境中自动推荐最可能的读音
  - 示例: "银行" → háng, "我行我素" → xíng
  - 候选面板: 无法推断时显示多音字候选
- **笔顺动画**: 可视化笔顺演示（可选）
- **临摹练习**: 简单的手写识别（可选）

### 5.5 内容管理

- **检索**: 按 Deck/Tag/Type/State/Due/难度/最近错误筛选
- **批量操作**:
  - 批量标签添加/移除
  - 批量移动到 Deck
  - 批量删除
  - 批量重排程（重置学习进度）
- **历史记录**: 条目变更与复习日志可视化
- **重复检测**: 语义指纹 + 编辑距离，避免同义词重复
- **验收**: 1000 条目内列表与搜索 P95 <500ms

### 5.6 统计与反馈

- **今日面板**:
  - 今日完成数/正确率/耗时
  - 未来 7/30 天任务预测曲线
  - 连续打卡天数（Streak）
- **深度分析**:
  - 难项排行（按 lapses 降序）
  - 错误高频标签
  - 记忆稳定度趋势图（S 值变化）
- **验收**: 指标与日志一致；导出 CSV 可复算

### 5.7 提醒机制

- **每日提醒**: 时间窗口配置（默认 20:00-22:00）
- **方式**:
  - PWA 推送通知（优先）
  - 邮件（备选）
- **可关闭**: 用户可完全禁用

### 5.8 导入导出与备份

- **格式**: CSV / JSON，UTF-8 编码
- **Anki 兼容**: 支持 Anki 样式 CSV 字段映射（不导入排程数据）
- **冲突处理**:
  - **语义指纹**: 对核心字段（释义、例句）生成哈希，检测实质性重复
  - **策略**: 跳过/覆盖/合并（用户选择）
  - **主字段唯一**: 英文 `word`、中文 `hanzi/词语`

- **备份策略 (v2.0 核心优化 - 自动化 + 容灾)**:
  - **自动触发**: `cron` 任务每日凌晨 2:00 自动执行，使用 SQLite `.backup` 命令（不锁表）
  - **异地存储**: 备份文件自动上传至 S3 兼容存储（AWS S3 / MinIO / 阿里云 OSS）
  - **保留策略**: 自动保留最近 30 天备份，超期自动清理
  - **恢复**: 管理员可从云端拉取任一备份版本进行一键恢复
  - **验证**: 备份后自动校验文件完整性（MD5）

- **验收标准**:
  - 导入 1000 行 ≤5s
  - 重复提示清晰，语义指纹准确率 ≥95%
  - 备份恢复流程可在 15 分钟内完成
  - 备份成功率 100%（失败时告警）

---

## 6. 非功能性需求

- **性能**:
  - **首屏加载**: P95 < 900ms (通过代码分割、CDN、Django 缓存、数据库索引优化实现)。
  - **复习翻面**: <100ms。
  - **API 响应**: P99 < 500ms。
- **可靠性**:
  - **评分落库**: 100% 成功。
  - **离线同步**: PWA 离线队列在网络恢复后自动同步，冲突时提示用户解决。
- **可用性**: 移动优先、暗色模式、无障碍设计。
- **安全**: 保持 v1.0 标准（本人数据隔离、CSRF/速率限制、API Key 不下发前端）。
- **隐私**: 仅存储学习数据，用户可随时导出/删除个人所有数据。

---

## 7. 技术基线 (v2.0)

- **架构**: 前后端分离
  - **后端**: Django 5 + Django REST Framework (DRF) + SQLite
  - **前端**: Vue 3 + Vite + Tailwind CSS
  - **PWA**: Workbox
- **数据源**: IndexedDB / ECDICT / UniHan DB / dictionaryapi.dev
- **部署**: Docker Compose (gunicorn + Nginx + cron)；S3 用于备份存储。

---

## 8. 度量指标

- **效率**: 录入并补全 ≤8 秒/条；补全触发成功率 ≥99%。
- **学习**: 30 日留存 ≥80%；成熟卡片（间隔>21天）正确率 ≥90%。
- **性能**: 首屏加载 P95 < 900ms；API 成功率 > 99.9%。
- **稳定**: 一周零数据丢失；备份恢复可用率 100%。

---

## 9. 里程碑与交付

- **M1 (1.7 周 / ~68 小时)**:
  - **内容**: 搭建 DRF 后端框架，完成数据模型迁移，实现用户认证和 CRUD API。集成完整 SM-2 算法。建立自动化备份到 S3 的流程。集成 ECDICT 本地字典。
  - **交付**: 可通过 API 完成核心操作，备份机制可用。
- **M2 (2.25 周 / ~90 小时)**:
  - **内容**: 搭建 Vue 3 + PWA 前端项目。完成复习、录入核心页面开发。实现 L1 (IndexedDB) 和 L2 (本地字典) 数据源策略。完成 PWA 离线访问和队列同步功能。
  - **交付**: 可离线使用的 PWA 应用，核心功能闭环。
- **M3 (1.5 周 / ~60 小时)**:
  - **内容**: 完成统计面板、批量管理等辅助功能。实现多音字语境推断。优化数据导入的语义指纹冲突检测。完成性能优化（CDN、代码分割等）。
  - **交付**: 功能完整的 v2.0 版本。
- **M4 (可选)**:
  - **内容**: 探索集成 FSRS 算法；集成 Azure TTS 等高质量语音合成服务。

---

## 10. 风险与对策

- **PWA 兼容性**: 部分旧浏览器支持不佳 -> **对策**: 明确支持范围（主流浏览器近两年版本），对不支持的设备优雅降级。
- **离线同步冲突**: 多设备离线修改后上线可能冲突 -> **对策**: 采用“后来者优先”策略并提示用户，或提供手动合并界面。
- **本地字典库过大**: 影响初始加载或 PWA 安装 -> **对策**: 对字典库进行预处理和分块，按需加载。
- **算法调参复杂**: SM-2/FSRS 参数影响用户体验 -> **对策**: 提供几套预设参数（保守/标准/激进），并允许高级用户自定义。

---

## 11. 开放问题

- **同步策略**: 离线数据同步冲突时，应自动合并、让用户选择，还是以服务器为准？
- **字典优先级**: 用户是否可以自定义 L1-L4 数据源的优先级或禁用某个源？
- **FSRS 集成成本**: FSRS 需要模型训练，是否值得为小规模用户引入这种复杂性？
- **TTS 服务**: 是否值得为更高质量的语音支付第三方 TTS 服务费用（如 Azure/Google）？

---

## 12. 验收清单（汇总）

- **架构**: PWA 可安装，核心功能可离线使用，网络恢复后数据自动同步。
- **数据源**: 四层降级策略按预期工作，API 故障时不影响核心使用。
- **复习算法**: 完整的 SM-2 算法已应用，间隔计算符合公式。
- **备份**: 每日自动备份在 S3 可见，恢复功能经验证可用。
- **新功能**: 多音字推断准确率可接受，导入冲突检测优于纯词形匹配。
- **性能**: 首屏加载 P95 指标 < 900ms。
